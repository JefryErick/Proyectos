<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Análisis de Propagación de Información</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.1.0/chartjs-plugin-annotation.min.js"></script>
    <style>
        /* Variables de color y sombra */
        :root {
            --primary-blue: #2563eb;
            --primary-blue-dark: #1d4ed8;
            --primary-blue-light: #3b82f6;
            --accent-blue: #0ea5e9;
            --dark-bg: #1e293b;
            --darker-bg: #353942;
            --light-gray: #f8fafc;
            --medium-gray: #64748b;
            --dark-gray: #334155;
            --border-gray: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-light: #94a3b8;
            --white: #ffffff;
            --danger: #dc2626;
            --success: #059669;
            --warning: #d97706;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --transition-fast: 0.15s ease-in-out;
            --transition-normal: 0.3s ease-in-out;
            --transition-slow: 0.5s ease-in-out;
        }

        /* Reset y estilos base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--dark-bg) 0%, var(--darker-bg) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 14px;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Header */
        .header {
            background: var(--white);
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-gray);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-blue) 0%, var(--accent-blue) 100%);
        }

        .header h1 {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            letter-spacing: -0.025em;
        }

        .header p {
            font-size: 1.1rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* Panel de controles */
        .controls-panel {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-gray);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .control-group input, 
        .control-group select {
            padding: 12px 16px;
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            font-size: 14px;
            transition: all var(--transition-fast);
            background: var(--white);
            color: var(--text-primary);
            font-family: inherit;
        }

        .control-group input:focus, 
        .control-group select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .control-group input:hover,
        .control-group select:hover {
            border-color: var(--primary-blue-light);
        }

        /* Botones */
        .btn {
            background: var(--primary-blue);
            color: var(--white);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: var(--shadow-sm);
        }

        .btn:hover {
            background: var(--primary-blue-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: var(--medium-gray);
            color: var(--white);
        }

        .btn-secondary:hover {
            background: var(--dark-gray);
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        /* Grid de métricas */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-gray);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-blue);
            transform: scaleX(0);
            transition: transform var(--transition-normal);
        }

        .metric-card:hover::before {
            transform: scaleX(1);
        }

        .metric-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .metric-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            font-size: 1.25rem;
            color: var(--white);
            background: var(--primary-blue);
            box-shadow: var(--shadow-sm);
        }

        .metric-icon.success {
            background: var(--success);
        }

        .metric-icon.warning {
            background: var(--warning);
        }

        .metric-icon.danger {
            background: var(--danger);
        }

        .metric-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 300;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-family: 'JetBrains Mono', Monaco, 'Courier New', monospace;
        }

        .metric-change {
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .positive { 
            color: var(--success); 
        }
        
        .negative { 
            color: var(--danger); 
        }

        .neutral {
            color: var(--text-secondary);
        }

        /* Grid de gráficos */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .chart-container {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-gray);
            transition: all var(--transition-normal);
        }

        .chart-container:hover {
            box-shadow: var(--shadow-lg);
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-gray);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .canvas-container {
            position: relative;
            height: 320px;
        }

        /* Panel de validación */
        .validation-panel {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-gray);
            margin-bottom: 24px;
        }

        .validation-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .model-results {
            background: var(--light-gray);
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid var(--primary-blue);
            transition: all var(--transition-fast);
        }

        .model-results:hover {
            background: #f1f5f9;
            border-left-color: var(--primary-blue-dark);
        }

        .model-results.lt-model {
            border-left-color: var(--accent-blue);
        }

        .model-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-gray);
            font-family: 'JetBrains Mono', Monaco, 'Courier New', monospace;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-row .metric-label {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-row .metric-value {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
        }

        /* Visualización de red */
        .network-viz {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-gray);
        }

        #network-svg {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            border: 1px solid var(--border-gray);
            background: var(--light-gray);
        }

        /* Estados de carga */
        .loading {
            display: none;
            text-align: center;
            padding: 32px;
            color: var(--text-secondary);
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid var(--border-gray);
            border-top: 3px solid var(--primary-blue);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Indicadores de estado */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
            position: relative;
        }

        .status-indicator::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 50%;
            background: inherit;
            opacity: 0.3;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.2); opacity: 0.1; }
        }

        .status-active { 
            background-color: var(--success); 
        }
        
        .status-inactive { 
            background-color: var(--danger); 
        }
        
        .status-processing { 
            background-color: var(--warning); 
        }

        /* Alertas y notificaciones */
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            gap: 12px;
            opacity: 0; /* Hidden by default */
            transition: opacity 0.3s ease-in-out;
        }

        .alert.show {
            opacity: 1;
        }

        .alert-info {
            background: #dbeafe;
            border-color: #bfdbfe;
            color: #1e40af;
        }

        .alert-success {
            background: #d1fae5;
            border-color: #a7f3d0;
            color: #065f46;
        }

        .alert-warning {
            background: #fef3c7;
            border-color: #fde68a;
            color: #92400e;
        }

        .alert-danger {
            background: #fee2e2;
            border-color: #fecaca;
            color: #991b1b;
        }
/*-----------------------------------------------------------------------------------------
        /* Admin-specific styles */
        .admin-section {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-gray);
            display: none; /* Hidden by default */
        }

        .admin-toggle {
            background: var(--warning);
            color: var(--white);
        }

        .admin-toggle:hover {
            background: #b45309;
        }

        .user-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .user-stat-card {
            background: var(--light-gray);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            border-left: 4px solid var(--primary-blue);
        }

        .user-stat-value {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary-blue);
            margin: 8px 0;
        }

        .user-stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
/*-----------------------------------------------------------------------------------------
        /* Responsive design */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 16px;
            }
            
            .header {
                padding: 24px;
            }
            
            .header h1 {
                font-size: 1.875rem;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .validation-results {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .metric-value {
                font-size: 2rem;
            }
            
            .canvas-container {
                height: 250px;
            }
        }

        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-gray);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--medium-gray);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--dark-gray);
        }

        /* Utilidades */
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        .font-mono { font-family: 'JetBrains Mono', Monaco, 'Courier New', monospace; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .uppercase { text-transform: uppercase; }
        .lowercase { text-transform: lowercase; }
        .capitalize { text-transform: capitalize; }
        .tracking-wide { letter-spacing: 0.05em; }
        .tracking-wider { letter-spacing: 0.1em; }
        
        .mb-0 { margin-bottom: 0; }
        .mb-2 { margin-bottom: 8px; }
        .mb-4 { margin-bottom: 16px; }
        .mb-6 { margin-bottom: 24px; }
        
        .mt-0 { margin-top: 0; }
        .mt-2 { margin-top: 8px; }
        .mt-4 { margin-top: 16px; }
        .mt-6 { margin-top: 24px; }


    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <h1>🌐 Análisis de Propagación de Información</h1>
            <p>Dashboard Interactivo para Grafos Temporales y Validación Cruzada</p>
            <!-- En el header, después de la descripción -->
            <div style="display: flex; justify-content: flex-end; margin-top: 16px;">
                <button id="admin-toggle-btn" class="btn admin-toggle">
                    <span class="status-indicator status-active"></span>
                    Mostrar Estadísticas de Usuarios
                </button>
            </div>
        </div>

        <!-- Message Area -->
        <div id="message-area" class="alert" style="display: none;"></div>

        <!-- Controls Panel -->
        <div class="controls-panel">
            <div class="controls-grid">
                <div class="control-group">
                    <label for="dataset-select">Dataset</label>
                    <select id="dataset-select">
                        <option value="twitter">Twitter Cascade</option>
                        <option value="digg">Digg Social News</option>
                        <option value="memetracker">Memetracker</option>
                        <option value="custom">Dataset Personalizado</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="time-window">Ventana Temporal (horas)</label>
                    <input type="number" id="time-window" value="24" min="1" max="168">
                </div>
                
                <div class="control-group">
                    <label for="bootstrap-samples">Muestras Bootstrap</label>
                    <input type="number" id="bootstrap-samples" value="1000" min="100" max="5000">
                </div>
                
                <div class="control-group">
                    <label for="cv-folds">Folds CV Temporal</label>
                    <input type="number" id="cv-folds" value="5" min="3" max="10">
                </div>
                
                <div class="control-group">
                    <button class="btn" id="run-analysis-btn">
                        <span class="status-indicator status-inactive"></span>
                        Ejecutar Análisis
                    </button>
                </div>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">📊</div>
                    <div class="metric-title">Cascadas Detectadas</div>
                </div>
                <div class="metric-value" id="total-cascades">0</div>
                <div class="metric-change positive" id="cascades-change">+0% desde última ejecución</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon" style="background: linear-gradient(135deg, #2ed573, #1e90ff); color: white;">🚀</div>
                    <div class="metric-title">Velocidad Promedio</div>
                </div>
                <div class="metric-value" id="avg-velocity">0.00</div>
                <div class="metric-change" id="velocity-change">nodos/segundo</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon" style="background: linear-gradient(135deg, #ffa726, #ff7043); color: white;">🎯</div>
                    <div class="metric-title">Alcance Máximo</div>
                </div>
                <div class="metric-value" id="max-reach">0</div>
                <div class="metric-change" id="reach-change">nodos alcanzados</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon" style="background: linear-gradient(135deg, #a855f7, #ec4899); color: white;">📈</div>
                    <div class="metric-title">Factor Viral</div>
                </div>
                <div class="metric-value" id="viral-factor">0.00</div>
                <div class="metric-change" id="viral-change">índice de viralidad</div>
            </div>
        </div>

        <!-- Admin User Stats Section -->
        <div id="admin-section" class="admin-section">
            <h2 class="chart-title">👥 Estadísticas de Usuarios</h2>
            
            <div class="user-stats-grid">
                <div class="user-stat-card">
                    <div class="user-stat-label">Usuarios Totales</div>
                    <div class="user-stat-value" id="total-users">1,248</div>
                    <div class="metric-change positive">+12% este mes</div>
                </div>
                
                <div class="user-stat-card">
                    <div class="user-stat-label">Usuarios Activos</div>
                    <div class="user-stat-value" id="active-users">892</div>
                    <div class="metric-change positive">71.5% del total</div>
                </div>
                
                <div class="user-stat-card">
                    <div class="user-stat-label">Nuevos (7 días)</div>
                    <div class="user-stat-value" id="new-users">84</div>
                    <div class="metric-change positive">+22% semanal</div>
                </div>
                
                <div class="user-stat-card">
                    <div class="user-stat-label">Análisis Realizados</div>
                    <div class="user-stat-value" id="total-analysis">3,742</div>
                    <div class="metric-change positive">+324 este mes</div>
                </div>
            </div>
            
            <div class="chart-container" style="margin-top: 24px;">
                <h3 class="chart-title">📊 Actividad de Usuarios (30 días)</h3>
                <div class="canvas-container">
                    <canvas id="user-activity-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Validation Results -->
        <div class="validation-panel">
            <h2 class="chart-title">🔬 Resultados de Validación Cruzada Temporal</h2>
            <div class="validation-results">
                <div class="model-results">
                    <div class="model-title">Modelo de Cascada Independiente (IC)</div>
                    <div class="metric-row">
                        <span class="metric-label">MAE (Error Absoluto Medio):</span>
                        <span class="metric-value" id="ic-mae">--</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">RMSE (Error Cuadrático Medio):</span>
                        <span class="metric-value" id="ic-rmse">--</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">R² (Coeficiente Determinación):</span>
                        <span class="metric-value" id="ic-r2">--</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Score de Robustez:</span>
                        <span class="metric-value" id="ic-robustez">--</span>
                    </div>
                </div>

                <div class="model-results">
                    <div class="model-title">Modelo de Umbral Lineal (LT)</div>
                    <div class="metric-row">
                        <span class="metric-label">MAE (Error Absoluto Medio):</span>
                        <span class="metric-value" id="lt-mae">--</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">RMSE (Error Cuadrático Medio):</span>
                        <span class="metric-value" id="lt-rmse">--</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">R² (Coeficiente Determinación):</span>
                        <span class="metric-value" id="lt-r2">--</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Score de Robustez:</span>
                        <span class="metric-value" id="lt-robustez">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <div class="chart-container">
                <h3 class="chart-title">📈 Bootstrap de Velocidades de Propagación</h3>
                <div class="canvas-container">
                    <canvas id="bootstrap-chart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">🎯 Distribución de Alcances</h3>
                <div class="canvas-container">
                    <canvas id="reach-distribution"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">⚡ Métricas de Viralidad</h3>
                <div class="canvas-container">
                    <canvas id="virality-metrics"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">🔄 Comparación de Modelos (CV)</h3>
                <div class="canvas-container">
                    <canvas id="models-comparison"></canvas>
                </div>
            </div>
        </div>

        <!-- Network Visualization -->
        <div class="network-viz">
            <h3 class="chart-title">🕸️ Visualización de Red de Propagación</h3>
            <svg id="network-svg"></svg>
        </div>

        <!-- Loading Indicator -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Ejecutando análisis de propagación...</p>
        </div>
    </div>

    <script>
        // Global application state
        let analysisData = {
            cascades: [],
            bootstrap_results: { velocities: [], reaches: [] },
            cv_results: {
                IC: { mae: 0, rmse: 0, r2: 0, robustez: 0 },
                LT: { mae: 0, rmse: 0, r2: 0, robustez: 0 }
            },
            metrics: {
                totalCascades: 0,
                avgVelocity: 0,
                maxReach: 0,
                viralFactor: 0
            },
            network: { nodes: [], links: [] }
        };

        // Chart.js instances
        const appCharts = {
            bootstrap: null,
            reach: null,
            virality: null,
            models: null
        };

        // Color configuration
        const colors = {
            primary: '#667eea',
            secondary: '#764ba2',
            success: '#27ae60',
            warning: '#f39c12',
            danger: '#e74c3c',
            info: '#3498db',
            chartBlue: 'rgba(59, 130, 246, 0.8)', // primary-blue-light with alpha
            chartPurple: 'rgba(168, 85, 247, 0.8)', // a855f7 with alpha
            chartGreen: 'rgba(5, 150, 105, 0.8)', // success with alpha
            chartRed: 'rgba(220, 38, 38, 0.8)' // danger with alpha
        };

        // DOM Elements
        const loadingElement = document.getElementById('loading');
        const runAnalysisBtn = document.getElementById('run-analysis-btn');
        const statusIndicator = runAnalysisBtn.querySelector('.status-indicator');
        const messageArea = document.getElementById('message-area');

        /**
         * Displays a message to the user.
         * @param {string} type - Type of message (info, success, warning, danger).
         * @param {string} message - The message text.
         */
        function displayMessage(type, message) {
            messageArea.className = `alert alert-${type}`;
            messageArea.textContent = message;
            messageArea.style.display = 'flex';
            messageArea.classList.add('show');
            setTimeout(() => {
                messageArea.classList.remove('show');
                setTimeout(() => messageArea.style.display = 'none', 300); // Hide after transition
            }, 5000); // Message disappears after 5 seconds
        }

        /**
         * Transforms raw backend data into the structured analysisData.
         * This function assumes a certain structure for the backend response.
         * @param {object} backendData - The data received from the backend.
         * @returns {object} Transformed data.
         */
        function transformBackendData(backendData) {
            const cascades = backendData.cascades_data.map(c => ({
                id: c.id,
                reach: c.alcance_total,
                velocity: c.velocidad_propagacion,
                depth: c.profundidad_maxima,
                // Assuming viralidad_metrics is an object with a factor_viralizacion property
                // and it applies generally or we take an average.
                virality: backendData.viralidad_metrics?.factor_viralizacion?.media || 0
            }));

            // Calculate metrics from cascades
            const totalCascades = cascades.length;
            const avgVelocity = cascades.length > 0 ? d3.mean(cascades, d => d.velocity) : 0;
            const maxReach = cascades.length > 0 ? d3.max(cascades, d => d.reach) : 0;
            const viralFactor = backendData.viralidad_metrics?.factor_viralizacion?.media || 0;

            // Generate simple network data from cascades for D3 visualization
            const networkNodes = cascades.map((c, i) => ({ id: `cascade-${c.id}`, group: i % 3 }));
            const networkLinks = [];
            // Add some arbitrary links for visualization, e.g., connecting a few cascades
            if (cascades.length > 1) {
                for (let i = 0; i < Math.min(cascades.length - 1, 10); i++) { // Limit links for clarity
                    networkLinks.push({ source: `cascade-${cascades[i].id}`, target: `cascade-${cascades[i+1].id}`, value: 1 });
                }
            }


            return {
                cascades: cascades,
                bootstrap_results: {
                    velocities: backendData.bootstrap_results?.velocidades_bootstrap || [],
                    reaches: backendData.bootstrap_results?.alcances_bootstrap || []
                },
                cv_results: {
                    IC: {
                        mae: backendData.cv_results?.IC?.mae || 0,
                        rmse: backendData.cv_results?.IC?.rmse || 0,
                        r2: backendData.cv_results?.IC?.r2 || 0,
                        robustez: backendData.cv_results?.IC?.robustez || 0
                    },
                    LT: {
                        mae: backendData.cv_results?.LT?.mae || 0,
                        rmse: backendData.cv_results?.LT?.rmse || 0,
                        r2: backendData.cv_results?.LT?.r2 || 0,
                        robustez: backendData.cv_results?.LT?.robustez || 0
                    }
                },
                metrics: {
                    totalCascades,
                    avgVelocity: avgVelocity.toFixed(2),
                    maxReach,
                    viralFactor: viralFactor.toFixed(2)
                },
                network: {
                    nodes: networkNodes,
                    links: networkLinks
                }
            };
        }

        /**
         * Simulates a backend response with realistic-looking data.
         * Replace this with actual API calls in a production environment.
         */
        function generateSimulatedBackendData(bootstrapSamples, cvFolds) {
            const numCascades = Math.floor(Math.random() * 50) + 50; // 50-100 cascades
            const cascadesData = Array.from({ length: numCascades }).map((_, i) => ({
                id: `C${i + 1}`,
                alcance_total: Math.floor(Math.random() * 1000) + 50, // 50-1050 nodes
                velocidad_propagacion: parseFloat((Math.random() * 0.5 + 0.1).toFixed(2)), // 0.1-0.6 nodes/sec
                profundidad_maxima: Math.floor(Math.random() * 20) + 5 // 5-25 depth
            }));

            const bootstrapVelocities = Array.from({ length: bootstrapSamples }).map(() => parseFloat((Math.random() * 0.5 + 0.1).toFixed(2)));
            const bootstrapReaches = Array.from({ length: bootstrapSamples }).map(() => Math.floor(Math.random() * 1000) + 50);

            const cvResults = {
                IC: {
                    mae: parseFloat((Math.random() * 0.2 + 0.1).toFixed(3)),
                    rmse: parseFloat((Math.random() * 0.3 + 0.15).toFixed(3)),
                    r2: parseFloat((Math.random() * 0.3 + 0.6).toFixed(3)),
                    robustez: parseFloat((Math.random() * 0.2 + 0.7).toFixed(3))
                },
                LT: {
                    mae: parseFloat((Math.random() * 0.2 + 0.05).toFixed(3)),
                    rmse: parseFloat((Math.random() * 0.3 + 0.1).toFixed(3)),
                    r2: parseFloat((Math.random() * 0.3 + 0.7).toFixed(3)),
                    robustez: parseFloat((Math.random() * 0.2 + 0.8).toFixed(3))
                }
            };

            const viralidadMetrics = {
                factor_viralizacion: {
                    media: parseFloat((Math.random() * 0.8 + 0.2).toFixed(2)),
                    desviacion_estandar: parseFloat((Math.random() * 0.1 + 0.05).toFixed(2))
                }
            };

            return {
                success: true,
                data: {
                    cascades_data: cascadesData,
                    bootstrap_results: {
                        velocidades_bootstrap: bootstrapVelocities,
                        alcances_bootstrap: bootstrapReaches
                    },
                    cv_results: cvResults,
                    viralidad_metrics: viralidadMetrics
                }
            };
        }


        /**
         * Updates the key metrics displayed on the dashboard.
         */
        function updateMetrics() {
            document.getElementById('total-cascades').textContent = analysisData.metrics.totalCascades;
            document.getElementById('avg-velocity').textContent = analysisData.metrics.avgVelocity;
            document.getElementById('max-reach').textContent = analysisData.metrics.maxReach;
            document.getElementById('viral-factor').textContent = analysisData.metrics.viralFactor;

            // Simple change indicators (can be made more dynamic with historical data)
            document.getElementById('cascades-change').textContent = `+${(Math.random() * 5).toFixed(1)}% desde última ejecución`;
            document.getElementById('velocity-change').textContent = `nodos/segundo`;
            document.getElementById('reach-change').textContent = `nodos alcanzados`;
            document.getElementById('viral-change').textContent = `índice de viralidad`;
        }

        /**
         * Initializes or updates the Chart.js charts.
         */
        function updateCharts() {
            // Chart 1: Bootstrap de Velocidades de Propagación (Histogram/Density)
            const bootstrapCtx = document.getElementById('bootstrap-chart').getContext('2d');
            const velocities = analysisData.bootstrap_results.velocities;
            const velocityBins = d3.histogram()
                .value(d => d)
                .domain(d3.extent(velocities))
                .thresholds(20)(velocities); // 20 bins

            const velocityLabels = velocityBins.map(d => `${d.x0.toFixed(2)}-${d.x1.toFixed(2)}`);
            const velocityData = velocityBins.map(d => d.length);

            if (appCharts.bootstrap) {
                appCharts.bootstrap.data.labels = velocityLabels;
                appCharts.bootstrap.data.datasets[0].data = velocityData;
                appCharts.bootstrap.update();
            } else {
                appCharts.bootstrap = new Chart(bootstrapCtx, {
                    type: 'bar',
                    data: {
                        labels: velocityLabels,
                        datasets: [{
                            label: 'Frecuencia',
                            data: velocityData,
                            backgroundColor: colors.chartBlue,
                            borderColor: colors.primary,
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: false }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Velocidad de Propagación (nodos/seg)' },
                                grid: { display: false }
                            },
                            y: {
                                title: { display: true, text: 'Número de Muestras' },
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Chart 2: Distribución de Alcances (Histogram/Density)
            const reachCtx = document.getElementById('reach-distribution').getContext('2d');
            const reaches = analysisData.bootstrap_results.reaches;
            const reachBins = d3.histogram()
                .value(d => d)
                .domain(d3.extent(reaches))
                .thresholds(20)(reaches); // 20 bins

            const reachLabels = reachBins.map(d => `${Math.floor(d.x0)}-${Math.floor(d.x1)}`);
            const reachData = reachBins.map(d => d.length);

            if (appCharts.reach) {
                appCharts.reach.data.labels = reachLabels;
                appCharts.reach.data.datasets[0].data = reachData;
                appCharts.reach.update();
            } else {
                appCharts.reach = new Chart(reachCtx, {
                    type: 'bar',
                    data: {
                        labels: reachLabels,
                        datasets: [{
                            label: 'Frecuencia',
                            data: reachData,
                            backgroundColor: colors.chartPurple,
                            borderColor: colors.secondary,
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: false }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Alcance (nodos)' },
                                grid: { display: false }
                            },
                            y: {
                                title: { display: true, text: 'Número de Muestras' },
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Chart 3: Métricas de Viralidad (Bar Chart)
            const viralityCtx = document.getElementById('virality-metrics').getContext('2d');
            const viralityLabels = ['Factor Viralización', 'Profundidad Promedio', 'Ancho Promedio'];
            const viralityValues = [
                analysisData.metrics.viralFactor,
                d3.mean(analysisData.cascades, d => d.depth).toFixed(2),
                d3.mean(analysisData.cascades, d => d.reach / d.depth).toFixed(2) // Simple approximation of average width
            ];

            if (appCharts.virality) {
                appCharts.virality.data.labels = viralityLabels;
                appCharts.virality.data.datasets[0].data = viralityValues;
                appCharts.virality.update();
            } else {
                appCharts.virality = new Chart(viralityCtx, {
                    type: 'bar',
                    data: {
                        labels: viralityLabels,
                        datasets: [{
                            label: 'Valor',
                            data: viralityValues,
                            backgroundColor: [colors.chartGreen, colors.chartBlue, colors.chartPurple],
                            borderColor: [colors.success, colors.primary, colors.secondary],
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: false }
                        },
                        scales: {
                            x: {
                                grid: { display: false }
                            },
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Chart 4: Comparación de Modelos (Radar Chart for CV metrics)
            const modelsCtx = document.getElementById('models-comparison').getContext('2d');
            const cvMetrics = ['MAE', 'RMSE', 'R²', 'Robustez'];
            const icData = [
                analysisData.cv_results.IC.mae,
                analysisData.cv_results.IC.rmse,
                analysisData.cv_results.IC.r2,
                analysisData.cv_results.IC.robustez
            ];
            const ltData = [
                analysisData.cv_results.LT.mae,
                analysisData.cv_results.LT.rmse,
                analysisData.cv_results.LT.r2,
                analysisData.cv_results.LT.robustez
            ];

            if (appCharts.models) {
                appCharts.models.data.labels = cvMetrics;
                appCharts.models.data.datasets[0].data = icData;
                appCharts.models.data.datasets[1].data = ltData;
                appCharts.models.update();
            } else {
                appCharts.models = new Chart(modelsCtx, {
                    type: 'radar',
                    data: {
                        labels: cvMetrics,
                        datasets: [
                            {
                                label: 'Modelo IC',
                                data: icData,
                                backgroundColor: 'rgba(37, 99, 235, 0.2)', // primary-blue with alpha
                                borderColor: colors.primary_blue,
                                borderWidth: 2,
                                fill: true
                            },
                            {
                                label: 'Modelo LT',
                                data: ltData,
                                backgroundColor: 'rgba(14, 165, 233, 0.2)', // accent-blue with alpha
                                borderColor: colors.accent_blue,
                                borderWidth: 2,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: false,
                            }
                        },
                        scales: {
                            r: {
                                angleLines: {
                                    display: false
                                },
                                suggestedMin: 0,
                                suggestedMax: 1, // Metrics like R2 are 0-1, MAE/RMSE can be higher but normalized for radar
                                pointLabels: {
                                    font: {
                                        size: 12
                                    }
                                },
                                ticks: {
                                    backdropColor: 'transparent',
                                    color: '#64748b'
                                }
                            }
                        }
                    }
                });
            }
        }

        /**
         * Updates the validation results table.
         */
        function updateValidationResults() {
            const ic = analysisData.cv_results.IC;
            const lt = analysisData.cv_results.LT;

            document.getElementById('ic-mae').textContent = ic.mae.toFixed(3);
            document.getElementById('ic-rmse').textContent = ic.rmse.toFixed(3);
            document.getElementById('ic-r2').textContent = ic.r2.toFixed(3);
            document.getElementById('ic-robustez').textContent = ic.robustez.toFixed(3);

            document.getElementById('lt-mae').textContent = lt.mae.toFixed(3);
            document.getElementById('lt-rmse').textContent = lt.rmse.toFixed(3);
            document.getElementById('lt-r2').textContent = lt.r2.toFixed(3);
            document.getElementById('lt-robustez').textContent = lt.robustez.toFixed(3);
        }

        /**
         * Initializes or updates the D3 force-directed network visualization.
         */
        function updateNetworkVisualization() {
            const svg = d3.select("#network-svg");
            const width = svg.node().getBoundingClientRect().width;
            const height = svg.node().getBoundingClientRect().height;

            // Clear previous elements
            svg.selectAll("*").remove();

            const nodes = analysisData.network.nodes;
            const links = analysisData.network.links;

            if (nodes.length === 0) {
                svg.append("text")
                    .attr("x", width / 2)
                    .attr("y", height / 2)
                    .attr("text-anchor", "middle")
                    .attr("fill", colors.text_secondary)
                    .text("No hay datos de red para visualizar.");
                return;
            }

            const simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id).distance(100))
                .force("charge", d3.forceManyBody().strength(-300))
                .force("center", d3.forceCenter(width / 2, height / 2));

            const link = svg.append("g")
                .attr("stroke", "#999")
                .attr("stroke-opacity", 0.6)
                .selectAll("line")
                .data(links)
                .join("line")
                .attr("stroke-width", d => Math.sqrt(d.value));

            const node = svg.append("g")
                .attr("stroke", "#fff")
                .attr("stroke-width", 1.5)
                .selectAll("circle")
                .data(nodes)
                .join("circle")
                .attr("r", 8)
                .attr("fill", d => d3.schemeCategory10[d.group])
                .call(drag(simulation));

            node.append("title")
                .text(d => d.id);

            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);
            });

            // Drag functionality for nodes
            function drag(simulation) {
                function dragstarted(event) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    event.subject.fx = event.subject.x;
                    event.subject.fy = event.subject.y;
                }

                function dragged(event) {
                    event.subject.fx = event.x;
                    event.subject.fy = event.y;
                }

                function dragended(event) {
                    if (!event.active) simulation.alphaTarget(0);
                    event.subject.fx = null;
                    event.subject.fy = null;
                }

                return d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended);
            }
        }

        /**
         * Orchestrates the update of all dashboard components.
         */
        function updateDashboard() {
            updateMetrics();
            updateCharts();
            updateValidationResults();
            updateNetworkVisualization();
        }

        /**
         * Main function to run the analysis.
         */
        async function runAnalysis() {
            // Show loading state
            loadingElement.classList.add('active');
            statusIndicator.className = 'status-indicator status-processing';
            runAnalysisBtn.disabled = true;
            displayMessage('info', 'Iniciando análisis de propagación...');

            try {
                const timeWindow = parseInt(document.getElementById('time-window').value);
                const bootstrapSamples = parseInt(document.getElementById('bootstrap-samples').value);
                const cvFolds = parseInt(document.getElementById('cv-folds').value);
                const dataset = document.getElementById('dataset-select').value;

                // --- Simulate backend call ---
                // In a real application, you would make a fetch call to your backend here.
                // Example:
                // const response = await fetch('/api/run-analysis', {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify({
                //         time_window: timeWindow,
                //         bootstrap_samples: bootstrapSamples,
                //         cv_folds: cvFolds,
                //         dataset_type: dataset
                //     })
                // });
                // const result = await response.json();
                // if (!result.success) throw new Error(result.message);
                //
                // // Simulate polling for completion (if analysis is async on backend)
                // await waitForAnalysisToComplete();
                //
                // // Fetch final results
                // const res = await fetch('/api/results');
                // const json = await res.json();
                // if (!json.success) throw new Error(json.message);
                // analysisData = transformBackendData(json.data);

                // For demonstration, use simulated data
                await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate network delay
                const simulatedResult = generateSimulatedBackendData(bootstrapSamples, cvFolds);
                if (!simulatedResult.success) throw new Error(simulatedResult.message);
                analysisData = transformBackendData(simulatedResult.data);
                // --- End simulate backend call ---

                updateDashboard();
                statusIndicator.className = 'status-indicator status-active';
                displayMessage('success', 'Análisis completado exitosamente.');

            } catch (error) {
                console.error('Error en análisis:', error);
                statusIndicator.className = 'status-indicator status-inactive';
                displayMessage('danger', `Error al ejecutar el análisis: ${error.message}`);
            } finally {
                loadingElement.classList.remove('active');
                runAnalysisBtn.disabled = false;
            }
        }

        /**
         * Simulates polling for analysis completion from a backend.
         * This function is a placeholder and assumes a /api/status endpoint.
         * @returns {Promise<void>}
         */
        async function waitForAnalysisToComplete() {
            let done = false;
            while (!done) {
                // In a real scenario, this would fetch status from backend
                // const res = await fetch('/api/status');
                // const status = await res.json();
                // if (status.progress >= 100) {
                //     done = true;
                // } else {
                //     await new Promise(resolve => setTimeout(resolve, 1000)); // Poll every second
                // }
                // For simulation, we assume it's "done" after the initial delay
                done = true;
            }
        }

        // Initialize dashboard on load
        document.addEventListener('DOMContentLoaded', () => {
            // Attach event listener to the button
            runAnalysisBtn.addEventListener('click', runAnalysis);

            // Run an initial analysis with default values or simulated data
            // This populates the dashboard on first load
            runAnalysis();
        });


        // Admin-specific functionality
        document.addEventListener('DOMContentLoaded', () => {
            const adminToggleBtn = document.getElementById('admin-toggle-btn');
            const adminSection = document.getElementById('admin-section');
            let adminSectionVisible = false;

            adminToggleBtn.addEventListener('click', () => {
                adminSectionVisible = !adminSectionVisible;
                
                if (adminSectionVisible) {
                    adminSection.style.display = 'block';
                    adminToggleBtn.textContent = 'Ocultar Estadísticas de Usuarios';
                    initializeUserActivityChart();
                } else {
                    adminSection.style.display = 'none';
                    adminToggleBtn.textContent = 'Mostrar Estadísticas de Usuarios';
                }
            });

            function initializeUserActivityChart() {
                const ctx = document.getElementById('user-activity-chart').getContext('2d');
                
                // Destroy previous chart if exists
                if (window.userActivityChart) {
                    window.userActivityChart.destroy();
                }
                
                // Sample data for user activity
                const labels = Array.from({length: 30}, (_, i) => `Día ${i+1}`);
                const loginData = Array.from({length: 30}, () => Math.floor(Math.random() * 50) + 20);
                const analysisData = Array.from({length: 30}, () => Math.floor(Math.random() * 30) + 10);
                
                window.userActivityChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Inicios de Sesión',
                                data: loginData,
                                borderColor: colors.primary,
                                backgroundColor: colors.primary + '20',
                                tension: 0.3,
                                fill: true
                            },
                            {
                                label: 'Análisis Realizados',
                                data: analysisData,
                                borderColor: colors.success,
                                backgroundColor: colors.success + '20',
                                tension: 0.3,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Actividad'
                                }
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>